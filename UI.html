<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Music Visualizer</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    @font-face {   
      font-family: 'ErasBoldITC';
      src: url('fonts/ERASBD.TTF') format('truetype');
    }
  
    @font-face {   
      font-family: 'VeraHumana95Bold';
      src: url('fonts/verahb.ttf') format('truetype');
    }

    body {
      padding: 20px;
      background-image:url("music1.gif");
    }

    .container {
      display: flex;
      flex-direction: row;
      align-items: center;
      justify-content: center;
      max-width: 500px;
      margin: auto;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
      transition: all 1.0s ease;
      background: white;
    }

    .text-section {
      flex: 1;
      padding: 30px;
    }

    .text-section h1 {
      margin-bottom: 15px;
      font-family: 'ErasBoldITC', sans-serif;
      font-weight: bold;
      font-size: 2.5em;
      color: #A57DC6;
      text-shadow: 2px 3px 0px rgb(0, 0, 0);
    }

    .text-section p {
      color: #000000;
      font-family: 'VeraHumana95Bold', sans-serif;
      font-weight: bold;
      line-height: 1.6;
    }

    .image-section {
      flex: 1;
      display: none; /* Hidden by Default */
      margin-top: 20px;
    }

    .image-section img {
      width: 100%;
      height: auto;
      display: block;
    }

    .custom-upload-button {
      display: inline-block;
      padding: 12px 24px;
      background-color: #A57DC6;
      color: white;
      font-size: 1em;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: background-color 0.3s ease;
      font-family: 'ErasBoldITC', sans-serif;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      margin-top: 25px;
    }

    .custom-upload-button:hover {
      background-color: #8f5db2;
    }

    /* stacked layout for controls */
    .control-buttons {
      margin-top: 20px;
      text-align: center;
      display: none; /* Hidden by Default */
      flex-direction: column;
      gap: 15px;
    }

    .control-buttons label {
      font-family: 'VeraHumana95Bold', sans-serif;
      margin-right: 8px;
    }

    /* make color pickers swatches */
    .control-buttons input[type="color"] {
      border: none;
      width: 50px;
      height: 50px;
      cursor: pointer;
      padding: 0;
      border-radius: 6px;
      overflow: hidden;
      box-shadow: 0 0 3px rgba(0,0,0,0.3);
    }

    .color-row {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 15px;
    }

    .color-box {
      display: flex;
      flex-direction: column;
      align-items: center;
      font-size: 0.85em;
      font-family: monospace;
    }

    .control-buttons select,
    .control-buttons button {
      padding: 8px 12px;
      border-radius: 6px;
      border: 2px solid #A57DC6;
      font-family: 'ErasBoldITC', sans-serif;
      cursor: pointer;
    }

    .control-buttons button {
      background-color: #A57DC6;
      color: white;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }

    .control-buttons button:hover {
      background-color: #8f5db2;
    }

    @keyframes float {
      0% { transform: translateY(0px); }
      50% { transform: translateY(-8px); }
      100% { transform: translateY(0px); }
    }

    .floating {
      animation: float 2.5s ease-in-out infinite;
    }

    .audio-player {
      display: none; /* Hidden by Default */
      margin-top: 20px;
      text-align: center;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="text-section">
    <!-- Left Side -->
      <h1 style="text-align:center">Music Visualizer</h1>
      <p style="text-align:center">
        Upload your favorite song and watch AI-driven visuals!
      </p>

      <!-- Visualization Controls -->
      <div class="control-buttons">
        <div class="color-row">
          <div class="color-box">
            <input id="c1" type="color" value="#ff5733" oninput="c1_val.textContent=this.value">
            <span id="c1_val">#ff5733</span>
          </div>
          <div class="color-box">
            <input id="c2" type="color" value="#33c1ff" oninput="c2_val.textContent=this.value">
            <span id="c2_val">#33c1ff</span>
          </div>
          <div class="color-box">
            <input id="c3" type="color" value="#90ee90" oninput="c3_val.textContent=this.value">
            <span id="c3_val">#90ee90</span>
          </div>
        </div>

        <div>
          <label for="style">Style:</label>
          <select id="style">
            <option value="radial_lines">Radial Lines</option>
            <option value="circles">Circles</option>
            <option value="bars">Bars</option>
          </select>
        </div>

        <button id="applyBtn">Apply Settings</button>
      </div>

      <!-- Upload Button -->
      <div class="upload-wrapper" style="text-align: center;">
        <label for="fileInput" class="custom-upload-button floating">Upload Song</label>
        <input type="file" id="fileInput" accept="audio/mpeg, audio/ogg, audio/wav" style="display: none;">
      </div>
    </div>

    <!-- Right Side -->
    <!-- Visualizer -->
    <div class="image-section">
      <img id="frameDisplay" src="loading.gif" alt="birthday.gif">

      <!-- Audio Player -->
      <div class="audio-player">
        <audio id="myAudio" controls>
          Your browser does not support the audio element.
        </audio>
      </div>
    </div>
  </div>

  <!-- Socket.IO -->
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
  <script>
    const fileInput = document.getElementById('fileInput');
    const audio = document.getElementById('myAudio');
    const uploadButton = document.querySelector('.custom-upload-button');
    const infoText = document.querySelector('.text-section p');
    const frameDisplay = document.getElementById('frameDisplay');

    const socket = io("http://localhost:8000", {transports: ["websocket"]});
    socket.on("connect", () => console.log("Connected to server"));
    
    socket.on("connect_error", (err) => {
      console.error("WebSocket connection failed:", err.message);
      alert("Failed to connect to the visualization server. Please try again later.");
    });

    socket.on("error", (err) => {
      console.error("Socket error:", err);
    });

    socket.on("disconnect", (reason) => {
      console.warn("Disconnected:", reason);
      if (reason !== "io client disconnect") {
        alert("Disconnected from the server. Check your network or server status.");
      }
    });

    socket.on("frame", (payload) => {
      try {
        if (!payload || !payload.frame_b64) {
          throw new Error("Invalid frame data received");
        }
        frameDisplay.src = "data:image/jpeg;base64," + payload.frame_b64;
      } catch (err) {
        console.error("Error displaying frame:", err);
      }
    });


    function sendUserInput(colors, style){
      socket.emit("user_input", { colors, style });
    }

    fileInput.addEventListener('change', function(){
      const file = this.files[0];
      if (!file) return;

      // File type validation
      if (!file.type.startsWith('audio/')) {
        alert("Please upload a valid audio file (MP3, OGG, WAV).");
        return;
      }

      try {
        const url = URL.createObjectURL(file);
        audio.src = url;

        // UI updates...
       infoText.style.display = 'none';
        document.querySelector('.audio-player').style.display = 'block';
        document.querySelector('.image-section').style.display = 'block';

        const container = document.querySelector('.container');
        container.style.maxWidth = '1000px';
        container.style.padding = '20px';

       uploadButton.textContent = 'Try Another Song!';
       uploadButton.classList.remove('floating');

       document.querySelector('.control-buttons').style.display = 'flex';

       sendUserInput(
          [document.getElementById('c1').value,
          document.getElementById('c2').value,
          document.getElementById('c3').value],
          document.getElementById('style').value
        );
      } catch (err) {
        console.error("Error loading file:", err);
        alert("Something went wrong while loading the audio file.");
      }
    });

    document.getElementById('applyBtn').addEventListener('click', () => {
      try {
        sendUserInput(
          [document.getElementById('c1').value,
           document.getElementById('c2').value,
           document.getElementById('c3').value],
         document.getElementById('style').value
      );
      } catch (err) {
        console.error("Error applying settings:", err);
        alert("Could not apply visualization settings.");
      }
    });
  </script>
</body>
</html>
